#include <Arduino.h>
#include <SPI.h>
#include <MFRC522.h>
#include <WiFi.h>
#include <PubSubClient.h>

// Pines RFID RC522 (ESP32)
#define RST_PIN 22
#define SS_PIN 21

// Pin Servomotor
#define MOTOR_PIN 13

// WiFi
const char* ssid = "iPhone de Jorge";
const char* password = "Arribalamaquina";

// MQTT
const char* mqtt_server = "broker.mqtt.cool";
const char* topic_verificar = "aeropuerto/verificar_rfid";
const char* topic_respuesta = "aeropuerto/puerta/respuesta";

MFRC522 rfid(SS_PIN, RST_PIN);
WiFiClient espClient;
PubSubClient client(espClient);

bool esperandoRespuesta = false;
unsigned long tiempoUltimaLectura = 0;
const unsigned long DELAY_LECTURAS = 3000;

void callback(char* topic, byte* payload, unsigned int length) {
  String mensaje = "";
  for (unsigned int i = 0; i < length; i++) {
    mensaje += (char)payload[i];
  }

  Serial.print("[MQTT] Respuesta recibida: ");
  Serial.println(mensaje);

  if (String(topic) == topic_respuesta) {
    if (mensaje == "ABRIR") {
      Serial.println("[OK] ACCESO AUTORIZADO - Abriendo puerta");
      abrirPuerta();
    } else if (mensaje == "DENEGAR") {
      Serial.println("[ERROR] ACCESO DENEGADO");
    }
    esperandoRespuesta = false;
  }
}

void abrirPuerta() {
  Serial.println("[MOTOR] Activando.. .");
  digitalWrite(MOTOR_PIN, HIGH);
  delay(3000);
  digitalWrite(MOTOR_PIN, LOW);
  Serial.println("[MOTOR] Desactivado");
}

void setupWiFi() {
  Serial.print("[WiFi] Conectando a ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);

  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 30) {
    delay(500);
    Serial.print(".");
    intentos++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n[WiFi] Conectado");
    Serial.print("[WiFi] IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\n[WiFi] ERROR: No se pudo conectar");
  }
}

void reconnectMQTT() {
  while (!client.connected()) {
    Serial.print("[MQTT] Conectando a ");
    Serial.print(mqtt_server);
    Serial.println("...");
    
    if (client.connect("ESP32_Puerta_Aeropuerto")) {
      Serial.println("[MQTT] Conectado");
      client.subscribe(topic_respuesta);
      Serial.print("[MQTT] Suscrito a: ");
      Serial.println(topic_respuesta);
    } else {
      Serial.print("[MQTT] Fallo, rc=");
      Serial.print(client.state());
      Serial.println(" Reintentando en 5s...");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(115200);
  Serial.println("\n=== ESP32 PUERTA - MODULO 3 ===");

  pinMode(MOTOR_PIN, OUTPUT);
  digitalWrite(MOTOR_PIN, LOW);

  SPI.begin();
  rfid.PCD_Init();
  
  Serial.println("[RFID] Lector RC522 inicializado");

  setupWiFi();

  client.setServer(mqtt_server, 1883);
  client. setCallback(callback);

  Serial.println("\n[SISTEMA] Listo.  Esperando tarjetas RFID...\n");
}

void loop() {
  if (!client.connected()) {
    reconnectMQTT();
  }
  client. loop();

  if (esperandoRespuesta) {
    return;
  }

  if (millis() - tiempoUltimaLectura < DELAY_LECTURAS) {
    return;
  }

  if (! rfid.PICC_IsNewCardPresent()) {
    return;
  }

  if (! rfid.PICC_ReadCardSerial()) {
    return;
  }

  String rfid_uid = "";
  for (byte i = 0; i < rfid.uid.size; i++) {
    rfid_uid += String(rfid. uid.uidByte[i], HEX);
  }
  rfid_uid.toUpperCase();

  Serial.print("[RFID] Tarjeta detectada: ");
  Serial.println(rfid_uid);

  Serial.print("[MQTT] Publicando a ");
  Serial.print(topic_verificar);
  Serial.print(": ");
  Serial.println(rfid_uid);

  client.publish(topic_verificar, rfid_uid.c_str());

  esperandoRespuesta = true;
  tiempoUltimaLectura = millis();

  rfid.PICC_HaltA();
  rfid. PCD_StopCrypto1();
}
