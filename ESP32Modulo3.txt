#!/usr/bin/env python3
"""
Servidor de AutorizaciÃ³n RFID
==============================
Este servidor se suscribe al broker MQTT, recibe los IDs RFID escaneados,
valida si estÃ¡n autorizados y responde con "pass" o "no pass".
"""

import paho.mqtt.client as mqtt
import json
import time

# ========== CONFIGURACIÃ“N ==========
MQTT_BROKER = "broker.mqtt.cool"
MQTT_PORT = 1883
TOPIC_ACCESO = "aeropuerto/rfid/acceso"      # Topic donde llegan los RFID
TOPIC_RESPUESTA = "aeropuerto/rfid/respuesta"  # Topic para enviar respuesta

# ========== LISTA DE RFID AUTORIZADOS ==========
# Agrega aquÃ­ los IDs decimales de las tarjetas autorizadas
RFIDS_AUTORIZADOS = [
    "1564707438"     
]

# ========== FUNCIONES DE CALLBACK ==========

def on_connect(client, userdata, flags, rc):
    """Callback cuando se conecta al broker"""
    if rc == 0:
        print("âœ“ Conectado al broker MQTT exitosamente")
        print(f"  Broker: {MQTT_BROKER}:{MQTT_PORT}")
        # Suscribirse al topic de accesos RFID
        client.subscribe(TOPIC_ACCESO)
        print(f"âœ“ Suscrito al topic: {TOPIC_ACCESO}")
        print("\n=== Servidor de AutorizaciÃ³n Activo ===")
        print(f"RFIDs autorizados en sistema: {len(RFIDS_AUTORIZADOS)}")
        print("Esperando lecturas RFID...\n")
    else:
        print(f"âœ— Error de conexiÃ³n. CÃ³digo: {rc}")
        if rc == 1:
            print("  VersiÃ³n de protocolo incorrecta")
        elif rc == 2:
            print("  Identificador rechazado")
        elif rc == 3:
            print("  Servidor no disponible")
        elif rc == 4:
            print("  Usuario o contraseÃ±a incorrectos")
        elif rc == 5:
            print("  No autorizado")


def on_message(client, userdata, msg):
    """Callback cuando se recibe un mensaje"""
    try:
        # Decodificar el mensaje JSON
        payload = msg.payload.decode('utf-8')
        print(f"ðŸ“¨ Mensaje recibido en '{msg.topic}'")
        print(f"   Payload: {payload}")
        
        # Parsear JSON
        data = json.loads(payload)
        device = data.get("device", "Desconocido")
        serial_rfid = data.get("serial", "")
        
        print(f"   Device: {device}")
        print(f"   RFID Serial: {serial_rfid}")
        
        # Validar si el RFID estÃ¡ autorizado
        if serial_rfid in RFIDS_AUTORIZADOS:
            respuesta = "pass"
            print(f"   âœ“ AUTORIZADO - Enviando '{respuesta}'")
        else:
            respuesta = "no pass"
            print(f"   âœ— NO AUTORIZADO - Enviando '{respuesta}'")
        
        # Publicar respuesta
        client.publish(TOPIC_RESPUESTA, respuesta)
        print(f"   ðŸ“¤ Respuesta publicada en '{TOPIC_RESPUESTA}'\n")
        
    except json.JSONDecodeError as e:
        print(f"âœ— Error al decodificar JSON: {e}")
        print(f"   Payload recibido: {msg.payload}\n")
    except Exception as e:
        print(f"âœ— Error procesando mensaje: {e}\n")


def on_disconnect(client, userdata, rc):
    """Callback cuando se desconecta del broker"""
    if rc != 0:
        print(f"âš  DesconexiÃ³n inesperada del broker. CÃ³digo: {rc}")
        print("  Intentando reconectar...")


def on_subscribe(client, userdata, mid, granted_qos):
    """Callback cuando se completa la suscripciÃ³n"""
    print(f"âœ“ SuscripciÃ³n confirmada (QoS: {granted_qos[0]})")


# ========== FUNCIONES AUXILIARES ==========

def agregar_rfid_autorizado(rfid_id):
    """Agrega un nuevo RFID a la lista de autorizados"""
    if rfid_id not in RFIDS_AUTORIZADOS:
        RFIDS_AUTORIZADOS.append(rfid_id)
        print(f"âœ“ RFID agregado: {rfid_id}")
        return True
    else:
        print(f"âš  RFID ya existe: {rfid_id}")
        return False


def remover_rfid_autorizado(rfid_id):
    """Remueve un RFID de la lista de autorizados"""
    if rfid_id in RFIDS_AUTORIZADOS:
        RFIDS_AUTORIZADOS.remove(rfid_id)
        print(f"âœ“ RFID removido: {rfid_id}")
        return True
    else:
        print(f"âš  RFID no encontrado: {rfid_id}")
        return False


def listar_rfids_autorizados():
    """Lista todos los RFIDs autorizados"""
    print("\n=== RFIDs Autorizados ===")
    if RFIDS_AUTORIZADOS:
        for idx, rfid in enumerate(RFIDS_AUTORIZADOS, 1):
            print(f"  {idx}. {rfid}")
    else:
        print("  (No hay RFIDs autorizados)")
    print()


# ========== FUNCIÃ“N PRINCIPAL ==========

def main():
    """FunciÃ³n principal del servidor"""
    print("\n" + "="*50)
    print("  SERVIDOR DE AUTORIZACIÃ“N RFID - AEROPUERTO")
    print("="*50 + "\n")
    
    # Crear cliente MQTT
    client = mqtt.Client(client_id="Python_Servidor_Autorizacion")
    
    # Configurar callbacks
    client.on_connect = on_connect
    client.on_message = on_message
    client.on_disconnect = on_disconnect
    client.on_subscribe = on_subscribe
    
    try:
        # Conectar al broker
        print(f"Conectando a {MQTT_BROKER}:{MQTT_PORT}...")
        client.connect(MQTT_BROKER, MQTT_PORT, 60)
        
        # Iniciar loop (bloqueante)
        client.loop_forever()
        
    except KeyboardInterrupt:
        print("\n\nâš  InterrupciÃ³n de usuario (Ctrl+C)")
        print("Cerrando servidor...")
        client.disconnect()
        print("âœ“ Servidor cerrado correctamente")
        
    except ConnectionRefusedError:
        print(f"âœ— No se pudo conectar al broker {MQTT_BROKER}:{MQTT_PORT}")
        print("  Verifica que el broker estÃ© accesible")
        
    except Exception as e:
        print(f"âœ— Error inesperado: {e}")
        client.disconnect()


# ========== EJECUCIÃ“N ==========

if _name_ == "_main_":
    main()
